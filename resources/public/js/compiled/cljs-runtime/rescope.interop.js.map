{"version":3,"sources":["rescope/interop.cljs"],"mappings":";AAeA;;;;;;;;qCAAA,rCAAOA,kFAOJC,OAAOC,UAAUC;AAPpB,AAQE,IAAMC,QAAU;AAAA,AACE,IAAMC,MAAI,yBAAA,zBAACC,kBAAqBL,UAAaM;AAA7C,AACE,oBAAMJ;AAAN,AACE,CAACA,0CAAAA,+CAAAA,PAAUE,2BAAAA;;AADb;;AAEAA;;IACdG,YAAU,AAACC,cAAiB,AAAaR,iBAAQ,iBAAAS,mBAAIR;AAAJ,AAAA,oBAAAQ;AAAAA;;AACIC;;;AAN3D,AAOE,CAAM,AAAaP,kBAAOI;;AAC1BJ;;AAEJ;;;;2BAAA,3BAAOQ,8DAGJC;AAHH,AAIE,IAAMC,cAAY,WAAKC;AAAL,AACE;mCAAOC;AAAP,AACE,YAAA,RAASC;AAAT,AAAc,QAACF,kCAAAA,8CAAAA,dAAEE,0BAAAA,pBAAKD,0BAAAA;;;IADjBA;;;;EAAAA;;oCAAAA;;;IAAAA;0BAAAA;;;;;;;AAD3B,AAGE,IAAAE,WAAS,iBAAAC,qBAAA,iDAAAC;AAAA,AAAA,YAAAC,kBAAA,KAAA;AAAA,AAAA,IAAAD,eAAAA;;AAAA,AAAA,IAAAE,qBAAA,AAAAC,cAAAH;AAAA,AAAA,GAAAE;AAAA,AAAA,IAAAF,eAAAE;AAAA,AAAA,GAAA,AAAAE,6BAAAJ;AAAA,IAAAK,kBAm6EsC,AAAAsG,sBAAA3G;IAn6EtCM,qBAAA,AAAAC,gBAAAF;IAAAG,WAAA,AAAAC,uBAAAH;AAAA,AAAA,GAAA,AAAA,iBAAAI,WAAA;;AAAA,AAAA,GAAA,CAAAA,WAAAJ;AAAA,IAAAK,aAAA,AAAAC,eAAAP,gBAAAK;QAAA,AAAAG,4CAAAF,WAAA,IAAA,/DAAOY;QAAP,AAAAV,4CAAAF,WAAA,IAAA,/DAASa;AAAT,AAAA,AAAA,AAAAV,uBAAAN,SAAA,qFAAA,2CAAA,7CACGe,mGAAU,EAAI,AAACE,oBAAID,IACP,AAAC9B,YAAY8B,GACbA;;AAHf,eAAA,CAAAd,WAAA;;;;AAAA;;;;;AAAA,OAAAK,qBAAA,AAAAC,gBAAAR,UAAA,AAAAS,uCAAA,AAAAC,qBAAAlB;;AAAA,OAAAe,qBAAA,AAAAC,gBAAAR,UAAA;;;AAAA,IAAAW,aAAA,AAAAC,gBAAApB;QAAA,AAAAa,4CAAAM,WAAA,IAAA,/DAAOI;QAAP,AAAAV,4CAAAM,WAAA,IAAA,/DAASK;AAAT,AAAA,OAAAH,eAAA,qFAAA,2CAAA,kHAAA,AAAAJ,uCAAA,AAAAK,eAAAtB,rNACGuB,mGAAU,EAAI,AAACE,oBAAID,IACP,AAAC9B,YAAY8B,GACbA;;;AAHf;;;;GAAA,KAAA;;AAAA,AAAA,OAAAzB,mBAAYN;;IAArBK,eAAA,EAAA,CAAAA,YAAA,OAAA,KAIS,6CAAA,mCAAAA,hFAAC4B;AAJV,AAAA,GAAA,CAAA5B,gBAAA;AAAA;;AAKS,4BAAAA,rBAAC6B;;;AAEd,AAAA;;;+BAAA,uCAAAC,tEAAMM;AAAN,AAAA,IAAAL,qBAAA;AAAA,AAAA,IAAAC,0BAAA,AAAA;AAAA,AAAA,IAAAC,wBAAA;;AAAA,AAAA,GAAA,CAAAA,wBAAAD;AAAA,AAAA,AAAAD,wBAAA,CAAA,UAAAE;;AAAA,eAAA,CAAAA,wBAAA;;;;AAAA;;;;AAAA,IAAAC,uBAAA,EAAA,CAAA,MAAA,AAAAH,4BAAA,AAAA,KAAAI,qBAAA,AAAAJ,yBAAA,KAAA,IAAA,OAAA;AAAA,AAAA,OAAAK,kEAAA,CAAA,UAAA,MAAAF;;;AAAA,AAAA,CAAA,oEAAA,kBAAAG,tFAAMD,+EAEHrD;AAFH,AAAA,IAAAuD,aAAAD;IAAAE,aAAA,AAAAxB,4CAAAuB,WAAA,IAAA;IAAAC,iBAAA,AAAAC,4BAAAD;YAAAA,RAEoC5C;gBAFpC,AAAA8C,4CAAAF,eAAA,vEAEqBtD;AAFrB,AAGE,OAACH,mCAAcC,OAAO,AAACW,yBAAS,qDAAA,rDAACoD,+CAAOnD,sEAAmBV;;;AAH7D,CAAA,uDAAA,vDAAMmD;;AAAN;AAAA,CAAA,iDAAA,WAAAM,5DAAMN;AAAN,AAAA,IAAAO,WAAA,AAAArB,gBAAAoB;IAAAA,eAAA,AAAAE,eAAAF;AAAA,AAAA,IAAAG,qBAAA;AAAA,AAAA,OAAAA,wDAAAF,SAAAD;;;AAAA,AAKA,AAAA;;;;uCAAA,+CAAAZ,tFAAMiB;AAAN,AAAA,IAAAhB,qBAAA;AAAA,AAAA,IAAAC,0BAAA,AAAA;AAAA,AAAA,IAAAC,wBAAA;;AAAA,AAAA,GAAA,CAAAA,wBAAAD;AAAA,AAAA,AAAAD,wBAAA,CAAA,UAAAE;;AAAA,eAAA,CAAAA,wBAAA;;;;AAAA;;;;AAAA,IAAAC,uBAAA,EAAA,CAAA,MAAA,AAAAH,4BAAA,AAAA,KAAAI,qBAAA,AAAAJ,yBAAA,KAAA,IAAA,OAAA;AAAA,AAAA,OAAAgB,0EAAA,CAAA,UAAA,MAAAb;;;AAAA,AAAA,CAAA,4EAAA,eAAAc,3FAAMD,uFAGHK;AAHH,AAAA,IAAAH,aAAAD;YAAA,AAAAjC,4CAAAkC,WAAA,IAAA,nEAGUtD;AAHV,AAIE,GAAM,YAAY,AAAC0D,0BAA6BD;AAAhD,AACE,IAAME,UAAQ,AAACC,kEAAaC,8DAAe7D;AAA3C,AACE,OAAC8D,6BAAgCL,IAAIE;;AAFzC;;;;AAJF,CAAA,+DAAA,/DAAMP;;AAAN;AAAA,CAAA,yDAAA,WAAAG,pEAAMH;AAAN,AAAA,IAAAI,WAAA,AAAA7B,gBAAA4B;IAAAA,eAAA,AAAAN,eAAAM;AAAA,AAAA,IAAAL,qBAAA;AAAA,AAAA,OAAAA,wDAAAM,SAAAD;;;AAAA,AAQA;;;uBAAA,oCAAAQ,3DAAME,sDAEHC;AAFH,AAAA,IAAAF,aAAAD;IAAAC,iBAAA,AAAAnB,4BAAAmB;WAAAA,PAE0BI;WAF1B,AAAAtB,4CAAAkB,eAAA,lEAEgBG;AAFhB,AAGE,YAAAE,KAAU,AAACC,8CAAMC,gBAAML,MAAM,AAAChC,qBAAQkC;;AAExC;;;+BAAA,/BAAqBI,sEAElBC;AAFH,AAGE,6BAAA,tBAACC,oBAAUD,4DAAU,WAAK3C,EAAE6C,EAAEC,EAAEC;AAAX,AAAc,oBAAM,iBAAAC,oBAAKF;AAAL,AAAA,oBAAAE;AAAO,OAACC,gDAAKH,EAAEC;;AAAfC;;;AAAN,AACE,OAACE,oBAAuBJ;;AAD1B;;;;AAGrC;;;;AAAoBK,2BAGlB,AAACC,kBAAQ,WAAKhB,KAAKE;AAAV,AAAgB,OAACe,oBAAuB,AAAClB,qBAAKC,KAAKE;;AAK9D;;;0BAAA,kCAAAgB,5DAAME;AAAN,AAAA,IAAAD,aAAAD;IAAAC,iBAAA,AAAAxC,4BAAAwC;WAAAA,PAOUjB;UAPV,AAAAtB,4CAAAuC,eAAA,jEAEWE;aAFX,AAAAzC,4CAAAuC,eAAA,uDAAA,3HAGWG;cAHX,AAAA1C,4CAAAuC,eAAA,rEAIWI;kBAJX,AAAA3C,4CAAAuC,eAAA,zEAKWK;AALX,AAQE,IAAMC,MAAI,KAAAC;AAAV,AACE,AAAOD,SAAIH,OAAOD;;AAClB,IAAAjF,2BAAA,gDAAAuF;AAAA,AAAA,YAAArF,kBAAA,KAAA;AAAA,AAAA,IAAAqF,eAAAA;;AAAA,AAAA,IAAApF,qBAAA,AAAAC,cAAAmF;AAAA,AAAA,GAAApF;AAAA,AAAA,IAAAoF,eAAApF;AAAA,AAAA,GAAA,AAAAE,6BAAAkF;AAAA,IAAAjF,kBAk3E+C,AAAAsG,sBAAArB;IAl3E/ChF,qBAAA,AAAAC,gBAAAF;IAAAkF,WAAA,AAAA9E,uBAAAH;AAAA,AAAA,GAAA,AAAA,iBAAAkF,WAAA;;AAAA,AAAA,GAAA,CAAAA,WAAAlF;AAAA,IAAAmF,aAAA,AAAA7E,eAAAP,gBAAAmF;QAAA,AAAA3E,4CAAA4E,WAAA,IAAA,/DAAOlE;QAAP,AAAAV,4CAAA4E,WAAA,IAAA,/DAASjE;AAAT,AAAA,AAAA,AAAAV,uBAAAyE,SACE,AAAmBH,qBAAI7D,EAAEC;;AAD3B,eAAA,CAAAgE,WAAA;;;;AAAA;;;;;AAAA,OAAAzE,qBAAA,AAAAC,gBAAAuE,UAAA,AAAAG,sCAAA,AAAAxE,qBAAAoE;;AAAA,OAAAvE,qBAAA,AAAAC,gBAAAuE,UAAA;;;AAAA,IAAAI,aAAA,AAAAvE,gBAAAkE;QAAA,AAAAzE,4CAAA8E,WAAA,IAAA,/DAAOpE;QAAP,AAAAV,4CAAA8E,WAAA,IAAA,/DAASnE;AAAT,AAAA,OAAAH,yCAAA,AAAAqE,sCAAA,AAAApE,eAAAgE,/EACE,AAAmBF,qBAAI7D,EAAEC;;;AAD3B;;;;GAAA,KAAA;;AAAA,AAAA,AAAAzB,yBAAYmF;;AAEZ,oBAAMC;AAAN,AACE,CAAM,AAAcC,iBAAKD;;AAD3B;;AAEA,OAAOC;;AAEX,GAAA,QAAAQ,oCAAAC,4CAAAC;AAAA;AAAA,AAAA,6BAAA,iBAAAC,6BAAA,AAAAC,6CAAA,xHAAUS;IAAVR,6BAAA,AAAAD,6CAAA;IAAAE,6BAAA,AAAAF,6CAAA;IAAAG,iCAAA,AAAAH,6CAAA;IAAAI,0BAAA,AAAA7D,4CAAA,mCAAA,gEAAA,iBAAA8D,eAAA;AAAA,AAAA,QAAAA,6CAAAA,+CAAAA;;AAAA,AAAA,YAAAC,kBAAA,AAAAC,+CAAA,kBAAA,cAAA,WAAAC;AAAA,AAAsB,OAAAA;GAAtB,4DAAAJ,wBAAAL,2BAAAE,2BAAAC,2BAAAC;;;AAEA,AAAAM,uEAAA,WAAA,WACGC;AADH,AAAA,kDAAA,uEAAA,bAEW,AAAUA,oEACV,0CAAA,YAAA,pCAAM,AAAoBA,wBACxB,AAASA","names":["rescope.interop/extend-class*","parent","props-obj","construct","child","obj","js/Reflect.construct","child*","prototype","js/Object.create","or__5045__auto__","js/undefined","rescope.interop/js-props","props","wrap-method","f","args","this","G__44731","iter__5522__auto__","s__44733","cljs.core/LazySeq","temp__5804__auto__","cljs.core/seq","cljs.core/chunked-seq?","c__5520__auto__","size__5521__auto__","cljs.core/count","b__44735","cljs.core/chunk-buffer","i__44734","vec__44747","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__44732","cljs.core/chunk-rest","vec__44763","cljs.core/first","cljs.core/cons","cljs.core/rest","k","v","cljs.core/fn?","cljs.core.into","cljs.core/clj->js","var_args","args__5774__auto__","len__5768__auto__","i__5769__auto__","argseq__5775__auto__","cljs.core/IndexedSeq","rescope.interop/extend-class","p__44793","vec__44796","map__44799","cljs.core/--destructure-map","cljs.core.get","seq44779","G__44780","cljs.core/next","self__5753__auto__","cljs.core.dissoc","rescope.interop/define-element!","p__44812","vec__44813","seq44808","G__44809","tag","js/window.customElements.get","element","rescope.interop.extend_class","js/HTMLElement","js/window.customElements.define","p__44816","map__44819","rescope.interop/blob","coll","type","opts","js/Blob","cljs.core.apply","cljs.core/array","rescope.interop/auto-revoked","a","cljs.core/add-watch","r","o","n","and__5043__auto__","cljs.core.not_EQ_","js/URL.revokeObjectURL","rescope.interop/blob-url","cljs.core/memoize","js/URL.createObjectURL","p__44823","map__44824","rescope.interop/request","url","method","headers","on-progress","xhr","js/XMLHttpRequest","s__44832","b__44834","i__44833","vec__44850","iter__44831","vec__44853","js/rescope","js/rescope.interop","js/rescope.interop.event-data","method-table__5641__auto__","cljs.core.atom","prefer-table__5642__auto__","method-cache__5643__auto__","cached-hierarchy__5644__auto__","hierarchy__5645__auto__","fexpr__44874","cljs.core/MultiFn","cljs.core.symbol","p1__44867#","rescope.interop/event-data","event","cljs.core/chunk-first"],"sourcesContent":["(ns rescope.interop\n  \"Wrapping gnarly JS interop with the browser API in a smart way.\n\n  NOTE: fns marked with ^:experimental rely on experimental browser APIs.\")\n\n;; Useful documentation of the JS interop used in this code:\n;; * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Details_of_the_Object_Model\n;; * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create\n;; * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty\n;;\n;; Explaining why super() can't be extended:\n;; * https://stackoverflow.com/questions/43836886/failed-to-construct-customelement-error-when-javascript-file-is-placed-in-head\n\n;; Note: js/Reflect.construct simply replicates a call to super() and in the\n;; case of custom HTML elements, the constructor must otherwise be empty!\n(defn- extend-class*\n  \"Private implementation of extend-class, expecting only JavaScript types. This\n  is simply a way to emulate the more modern class-based JS while still using\n  its prototype-based subclassing.\n\n  The primary goal was to emulate a call to super() in the constructor. This is\n  a requirement when creating custom HTML components.\"\n  [parent props-obj construct]\n  (let [child     (fn child* []\n                    (let [obj (js/Reflect.construct parent #js[] child*)]\n                      (when construct\n                        (construct obj))\n                      obj))\n        prototype (js/Object.create (.-prototype parent) (or props-obj\n                                                             js/undefined))]\n    (set! (.-prototype child) prototype)\n    child))\n\n(defn- js-props\n  \"Convert a map of properties into a properties object that can be consumed by\n  extend-class*.\"\n  [props]\n  (let [wrap-method (fn [f]\n                      (fn [& args]\n                        (this-as this (f this args))))]\n    (some->> (for [[k v] props]\n               [k {:value (if (fn? v)\n                            (wrap-method v)\n                            v)}])\n             (into {})\n             (clj->js))))\n\n(defn extend-class\n  \"Extend the prototype of a `parent` class with a map of object `props`.\"\n  [parent & [{:keys [construct] :as props}]]\n  (extend-class* parent (js-props (dissoc props :construct)) construct))\n\n(defn define-element!\n  \"Define a custom element based on a `tag` name. Can optionally take a map of\n  `props` to refine the prototype of the new HTMLElement subclass.\"\n  [tag & [props]]\n  (when (undefined? (js/window.customElements.get tag))\n    (let [element (extend-class js/HTMLElement props)]\n      (js/window.customElements.define tag element))))\n\n(defn blob\n  \"Create a Blob object from a `coll` of content and a `type` (from `opts`).\"\n  [coll {:keys [type] :as opts}]\n  (js/Blob. (apply array coll) (clj->js opts)))\n\n(defn ^:experimental auto-revoked\n  \"Wrap an atom `a` holding an object URL to auto-revoke the older objects.\"\n  [a]\n  (add-watch a :change (fn [k r o n] (when (and o (not= o n))\n                                       (js/URL.revokeObjectURL o)))))\n\n(def ^:experimental blob-url\n  \"Create (or reuse) an object URL for a custom Blob based on `coll` and `opts`.\n  Use together with auto-revoked to properly garbage-collect dangling objects.\"\n  (memoize (fn [coll opts] (js/URL.createObjectURL (blob coll opts)))))\n\n;; TODO: finish, still very WIP\n;; See: https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest\n;; https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch\n(defn request\n  \"Wrapping XMLHttpRequest as a function to make it more accessible.\"\n  [{:keys [url\n           method\n           headers\n           on-progress]\n    :or   {method \"GET\"}\n    :as   opts}]\n  (let [xhr (js/XMLHttpRequest.)]\n    (.open xhr method url)\n    (for [[k v] headers]\n      (.setRequestHeader xhr k v))\n    (when on-progress\n      (set! (.-onprogress xhr) on-progress))\n    (.send xhr)))\n\n(defmulti event-data #(.-type %))\n\n(defmethod event-data \"progress\"\n  [event]\n  {:loaded (.-loaded event)\n   :total  (when (.-lengthComputable event)\n             (.-total event))})\n"]}